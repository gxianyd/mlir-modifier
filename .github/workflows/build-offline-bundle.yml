name: Build Offline Bundle

on:
  release:
    types: [created]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build offline bundle
        run: ./scripts/bundle-offline.sh

      - name: Rename bundle with platform tag
        run: |
          VER=$(python3 -c "import sys; print(f'py{sys.version_info.major}{sys.version_info.minor}')")
          mv offline-bundle.tar.gz offline-bundle-linux-x86_64-${VER}.tar.gz
          echo "BUNDLE=offline-bundle-linux-x86_64-${VER}.tar.gz" >> "$GITHUB_ENV"

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ github.event.release.tag_name }} "$BUNDLE"

      - name: Upload as artifact (manual run)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUNDLE }}
          path: ${{ env.BUNDLE }}
